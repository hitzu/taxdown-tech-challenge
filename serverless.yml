service: taxdown-customer-service

frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'prod'}
  region: us-east-2
  memorySize: 512
  timeout: 29
  environment:
    NODE_ENV: ${env:NODE_ENV, 'local'}
    DB_URL: ${env:DB_URL, ''}
    DB_SCHEMA: ${env:DB_SCHEMA, 'public'}
  httpApi:
    cors: true

functions:
  api:
    # Let serverless-esbuild bundle from TS source (much smaller artifacts)
    handler: src/lambda.handler
    events:
      - httpApi:
          path: /
          method: "*"
      - httpApi:
          path: /{proxy+}
          method: "*"

plugins:
  - serverless-esbuild
  - serverless-offline
  - serverless-dotenv-plugin

custom:
  dotenv:
    file: .env.local
  esbuild:
    bundle: true
    minify: true
    sourcemap: false
    target: node20
    platform: node
    keepNames: true # Preserve class/function names for NestJS DI
    exclude:
      - aws-sdk
      - "@nestjs/microservices"
      - "@nestjs/microservices/microservices-module"
      - "@nestjs/websockets/socket-module"
    plugins: esbuild.plugins.js
    packager: pnpm
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    noPrependStageInUrl: true
